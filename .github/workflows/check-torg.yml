name: Check car listings (Rosim / Konfiskat)

on:
  schedule:
    # Every hour at :00
    - cron: "0 * * * *"
  workflow_dispatch:

env:
  # Add repo secrets: VIN, PLATE_NUMBER, TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID
  VIN: ${{ secrets.VIN }}
  PLATE_NUMBER: ${{ secrets.PLATE_NUMBER }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Run torg check
        run: python run_check.py
        continue-on-error: true
        id: check

      - name: Set debug artifact flag
        if: always()
        id: debug
        run: |
          if [ -f konfiskat_debug.html ]; then echo "exists=true" >> $GITHUB_OUTPUT; else echo "exists=false" >> $GITHUB_OUTPUT; fi

      - name: Upload Konfiskat debug HTML
        if: always() && steps.debug.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: konfiskat-debug-html
          path: konfiskat_debug.html

      - name: Fail job if listing found
        if: steps.check.outcome == 'failure'
        run: |
          echo "::warning::Car listing detected. Check Telegram and the sites."
          exit 1
